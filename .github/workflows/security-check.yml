name: Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for exposed secrets
      run: |
        echo "Checking for exposed API keys..."
        
        # Check for Groq API keys (exclude security check files themselves)
        if grep -r "gsk_" . \
          --exclude-dir=node_modules \
          --exclude-dir=.git \
          --exclude-dir=.github \
          --exclude="*.ps1" \
          --exclude="*.md" \
          --exclude="check-security.*" | grep -v "your_groq_api_key_here"; then
          echo "ERROR: Real Groq API key found in code!"
          exit 1
        fi
        
        # Check for Google API keys
        if grep -r "AIzaSy" . \
          --exclude-dir=node_modules \
          --exclude-dir=.git \
          --exclude-dir=.github \
          --exclude="*.ps1" \
          --exclude="*.md" | grep -v "AIzaSy.*example"; then
          echo "ERROR: Real Google API key found in code!"
          exit 1
        fi
        
        # Check if .env files are committed (exclude .env.example)
        if git ls-files | grep -E "\.env$|\.env\.local$" | grep -v "\.env\.example"; then
          echo "ERROR: .env files should not be committed!"
          exit 1
        fi
        
        echo "✓ No secrets found in code"
    
    - name: Verify .gitignore
      run: |
        if ! grep -q "\.env" .gitignore; then
          echo "ERROR: .env not in .gitignore!"
          exit 1
        fi
        echo "✓ .gitignore is properly configured"
